// app.js - Complete Trade Journal Application

// Firebase Imports
import { initializeApp } from "firebase/app";
import { getFirestore, collection, addDoc, query, where, getDocs } from "firebase/firestore";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
         sendEmailVerification, sendPasswordResetEmail, onAuthStateChanged } from "firebase/auth";

// Firebase Configuration - Replace with your project details
const firebaseConfig = {
  apiKey: "AIzaSyBcO4eJCLyyDcvEfKtqbYPTsn3rNPK5xtw",
      authDomain: "trading-journal-emm.firebaseapp.com",
      projectId: "trading-journal-emm",
      storageBucket: "trading-journal-emm.firebasestorage.app",
      messagingSenderId: "219067165137",
      appId: "1:219067165137:web:b30c816cc63eee92e198f0",
      measurementId: "G-V7VXL7LNNM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// HTML Structure
document.body.innerHTML = `
  <div id="user-status"></div>
  
  <div id="auth-container">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="signupButton">Sign Up</button>
    <button id="signinButton">Sign In</button>
    <button id="resetButton">Reset Password</button>
  </div>
  
  <div id="calculator-container" style="display: none;">
    <h2>Trade Calculator</h2>
    <input type="text" id="ticker" placeholder="Ticker">
    <input type="number" id="entryPrice" placeholder="Entry Price">
    <input type="number" id="exitPrice" placeholder="Exit Price">
    <select id="tradeType">
      <option value="long">Long</option>
      <option value="short">Short</option>
    </select>
    <input type="number" id="margin" placeholder="Margin">
    <button id="logTradeButton">Log Trade</button>
    <div id="trades-list"></div>
  </div>
`;

// Authentication Functions
async function signUp(email, password) {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    await sendEmailVerification(userCredential.user);
    alert('Verification email sent! Please check your inbox.');
    return userCredential.user;
  } catch (error) {
    alert(`Sign Up Error: ${error.message}`);
  }
}

async function signIn(email, password) {
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    return userCredential.user;
  } catch (error) {
    alert(`Sign In Error: ${error.message}`);
  }
}

async function resetPassword(email) {
  if (!email) {
    alert("Email is required");
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    alert('Password reset email sent!');
  } catch (error) {
    alert(`Password Reset Error: ${error.message}`);
  }
}

// Trade Management Functions
async function logTrade(tradeDetails, user) {
  if (!user) {
    alert("Please sign in to log trades");
    return;
  }
  
  try {
    const docRef = await addDoc(collection(db, "trades"), {
      userId: user.uid,
      ticker: tradeDetails.ticker,
      entryPrice: tradeDetails.entryPrice,
      exitPrice: tradeDetails.exitPrice || null,
      tradeType: tradeDetails.tradeType,
      margin: tradeDetails.margin,
      timestamp: new Date(),
      profit: tradeDetails.profit || 0,
      status: tradeDetails.status || 'open'
    });
    alert('Trade logged successfully!');
    return docRef;
  } catch (error) {
    alert(`Error logging trade: ${error.message}`);
  }
}

async function getUserTrades(user) {
  if (!user) return;
  
  try {
    const tradesQuery = query(
      collection(db, "trades"),
      where("userId", "==", user.uid)
    );
    
    const querySnapshot = await getDocs(tradesQuery);
    const tradesList = document.getElementById('trades-list');
    tradesList.innerHTML = '<h3>Your Trades</h3>';
    
    querySnapshot.forEach(doc => {
      const trade = doc.data();
      tradesList.innerHTML += `
        <div class="trade-item">
          <p>Ticker: ${trade.ticker}</p>
          <p>Entry: ${trade.entryPrice}</p>
          <p>Exit: ${trade.exitPrice || 'Open'}</p>
          <p>Type: ${trade.tradeType}</p>
          <p>Date: ${trade.timestamp.toDate().toLocaleString()}</p>
        </div>
      `;
    });
  } catch (error) {
    alert(`Error fetching trades: ${error.message}`);
  }
}

// UI State Management
function setupAuthStateListener() {
  onAuthStateChanged(auth, (user) => {
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const userStatus = document.getElementById('user-status');
    
    if (user) {
      authContainer.style.display = 'none';
      calculatorContainer.style.display = 'block';
      userStatus.textContent = `Logged in as: ${user.email}`;
      getUserTrades(user);
    } else {
      authContainer.style.display = 'block';
      calculatorContainer.style.display = 'none';
      userStatus.textContent = 'Not Logged In';
    }
  });
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  setupAuthStateListener();
  
  document.getElementById('signupButton').addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    signUp(email, password);
  });
  
  document.getElementById('signinButton').addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    signIn(email, password);
  });
  
  document.getElementById('resetButton').addEventListener('click', () => {
    const email = document.getElementById('email').value;
    resetPassword(email);
  });
  
  document.getElementById('logTradeButton').addEventListener('click', () => {
    const trade = {
      ticker: document.getElementById('ticker').value,
      entryPrice: parseFloat(document.getElementById('entryPrice').value),
      exitPrice: parseFloat(document.getElementById('exitPrice').value),
      tradeType: document.getElementById('tradeType').value,
      margin: parseFloat(document.getElementById('margin').value)
    };
    logTrade(trade, auth.currentUser);
  });
});

// Add some basic styles
const styles = `
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    input, select, button { margin: 5px; padding: 8px; }
    button { cursor: pointer; }
    .trade-item { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
  </style>
`;
document.head.insertAdjacentHTML('beforeend', styles);
